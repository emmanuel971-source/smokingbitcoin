import React, { useState, useEffect } from 'react';
import { TrendingUp, Cigarette, Bitcoin, Globe, Info, AlertCircle } from 'lucide-react';

// Base de données des prix des cigarettes (prix moyen par paquet de 20 en USD)
const cigarettePriceData = {
  'USA': {
    2010: 5.51, 2011: 5.95, 2012: 6.23, 2013: 6.41, 2014: 6.53, 
    2015: 6.43, 2016: 6.52, 2017: 6.65, 2018: 6.85, 2019: 6.96,
    2020: 7.10, 2021: 7.35, 2022: 7.93, 2023: 8.25, 2024: 8.75, 2025: 9.10
  },
  'Canada': {
    2010: 8.20, 2011: 8.85, 2012: 9.45, 2013: 10.15, 2014: 10.80,
    2015: 11.50, 2016: 12.30, 2017: 13.15, 2018: 14.05, 2019: 14.95,
    2020: 15.90, 2021: 16.85, 2022: 17.80, 2023: 19.50, 2024: 21.20, 2025: 22.50
  },
  'France': {
    2010: 6.50, 2011: 6.80, 2012: 7.10, 2013: 7.50, 2014: 7.90,
    2015: 8.30, 2016: 8.70, 2017: 9.20, 2018: 9.70, 2019: 10.20,
    2020: 10.70, 2021: 11.30, 2022: 11.90, 2023: 12.50, 2024: 13.10, 2025: 13.50
  },
  'Germany': {
    2010: 5.80, 2011: 6.05, 2012: 6.30, 2013: 6.55, 2014: 6.80,
    2015: 7.05, 2016: 7.30, 2017: 7.55, 2018: 7.80, 2019: 8.05,
    2020: 8.30, 2021: 8.55, 2022: 8.90, 2023: 9.25, 2024: 9.60, 2025: 9.85
  },
  'UK': {
    2010: 9.20, 2011: 9.80, 2012: 10.40, 2013: 11.00, 2014: 11.60,
    2015: 12.20, 2016: 12.80, 2017: 13.50, 2018: 14.20, 2019: 14.90,
    2020: 15.60, 2021: 16.30, 2022: 17.10, 2023: 17.90, 2024: 18.70, 2025: 19.50
  },
  'Spain': {
    2010: 4.80, 2011: 5.00, 2012: 5.20, 2013: 5.40, 2014: 5.60,
    2015: 5.80, 2016: 6.00, 2017: 6.20, 2018: 6.45, 2019: 6.70,
    2020: 6.95, 2021: 7.20, 2022: 7.50, 2023: 7.80, 2024: 8.10, 2025: 8.40
  },
  'Italy': {
    2010: 5.50, 2011: 5.70, 2012: 5.90, 2013: 6.10, 2014: 6.30,
    2015: 6.50, 2016: 6.70, 2017: 6.90, 2018: 7.15, 2019: 7.40,
    2020: 7.65, 2021: 7.90, 2022: 8.20, 2023: 8.50, 2024: 8.80, 2025: 9.10
  },
  'Australia': {
    2010: 13.50, 2011: 15.20, 2012: 17.00, 2013: 18.90, 2014: 20.80,
    2015: 22.70, 2016: 24.80, 2017: 27.00, 2018: 29.50, 2019: 32.10,
    2020: 34.90, 2021: 37.80, 2022: 40.90, 2023: 44.20, 2024: 47.60, 2025: 51.20
  }
};

const translations = {
  fr: {
    title: "Bitcoin vs Cigarettes",
    subtitle: "Et si vous aviez investi dans le Bitcoin plutôt que dans les cigarettes ?",
    country: "Votre pays",
    cigarettesPerDay: "Cigarettes par jour",
    smokingSince: "Fumeur depuis",
    calculate: "Calculer mon manque à gagner",
    result: "Votre manque à gagner",
    totalSpent: "Argent dépensé en cigarettes",
    btcValue: "Valeur en Bitcoin aujourd'hui",
    btcAmount: "Bitcoin accumulé",
    avgBtcPrice: "Prix moyen du Bitcoin",
    loading: "Chargement des données Bitcoin...",
    error: "Impossible de charger les données Bitcoin",
    methodology: "Voir la méthodologie",
    disclaimer: "Les performances passées ne présument pas de celles à venir. Ce site n'est pas un conseil en investissement mais il n'est jamais trop tard pour investir dans votre santé.",
    years: "ans"
  },
  en: {
    title: "Bitcoin vs Cigarettes",
    subtitle: "What if you had invested in Bitcoin instead of cigarettes?",
    country: "Your country",
    cigarettesPerDay: "Cigarettes per day",
    smokingSince: "Smoking since",
    calculate: "Calculate my opportunity cost",
    result: "Your opportunity cost",
    totalSpent: "Money spent on cigarettes",
    btcValue: "Bitcoin value today",
    btcAmount: "Bitcoin accumulated",
    avgBtcPrice: "Average Bitcoin price",
    loading: "Loading Bitcoin data...",
    error: "Unable to load Bitcoin data",
    methodology: "View methodology",
    disclaimer: "Past performance does not guarantee future results. This site is not investment advice, but it's never too late to invest in your health.",
    years: "years"
  },
  es: {
    title: "Bitcoin vs Cigarrillos",
    subtitle: "¿Y si hubieras invertido en Bitcoin en lugar de en cigarrillos?",
    country: "Tu país",
    cigarettesPerDay: "Cigarrillos por día",
    smokingSince: "Fumador desde",
    calculate: "Calcular mi coste de oportunidad",
    result: "Tu coste de oportunidad",
    totalSpent: "Dinero gastado en cigarrillos",
    btcValue: "Valor en Bitcoin hoy",
    btcAmount: "Bitcoin acumulado",
    avgBtcPrice: "Precio medio del Bitcoin",
    loading: "Cargando datos de Bitcoin...",
    error: "No se pueden cargar los datos de Bitcoin",
    methodology: "Ver metodología",
    disclaimer: "El rendimiento pasado no garantiza resultados futuros. Este sitio no es un consejo de inversión, pero nunca es tarde para invertir en tu salud.",
    years: "años"
  }
};

export default function BitcoinVsCigarettes() {
  const [language, setLanguage] = useState('fr');
  const [country, setCountry] = useState('France');
  const [cigarettesPerDay, setCigarettesPerDay] = useState(10);
  const [yearsSmoking, setYearsSmoking] = useState(5);
  const [result, setResult] = useState(null);
  const [btcPriceData, setBtcPriceData] = useState(null);
  const [loading, setLoading] = useState(false);
  const [showMethodology, setShowMethodology] = useState(false);

  const t = translations[language];

  // Détecter le pays de l'utilisateur
  useEffect(() => {
    const detectCountry = async () => {
      try {
        const response = await fetch('https://ipapi.co/json/');
        const data = await response.json();
        const countryCode = data.country_code;
        
        const countryMap = {
          'US': 'USA',
          'CA': 'Canada',
          'FR': 'France',
          'DE': 'Germany',
          'GB': 'UK',
          'ES': 'Spain',
          'IT': 'Italy',
          'AU': 'Australia'
        };
        
        if (countryMap[countryCode]) {
          setCountry(countryMap[countryCode]);
        }
        
        // Détecter la langue
        if (countryCode === 'FR') setLanguage('fr');
        else if (countryCode === 'ES') setLanguage('es');
        else setLanguage('en');
      } catch (error) {
        console.log('Country detection failed, using default');
      }
    };
    
    detectCountry();
  }, []);

  const calculateInvestment = async () => {
    setLoading(true);
    
    try {
      // Récupérer les prix historiques du Bitcoin
      const response = await fetch(
        'https://api.coingecko.com/api/v3/coins/bitcoin/market_chart?vs_currency=usd&days=max&interval=monthly'
      );
      const data = await response.json();
      
      // Créer un index mensuel des prix BTC
      const btcMonthlyPrices = {};
      data.prices.forEach(([timestamp, price]) => {
        const date = new Date(timestamp);
        const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        btcMonthlyPrices[monthKey] = price;
      });

      // Calculer l'investissement cumulé
      const startYear = Math.max(2010, new Date().getFullYear() - yearsSmoking);
      const currentYear = new Date().getFullYear();
      const currentMonth = new Date().getMonth() + 1;
      
      let totalSpent = 0;
      let totalBTC = 0;
      let monthCount = 0;
      
      for (let year = startYear; year <= currentYear; year++) {
        const startMonth = (year === startYear) ? new Date().getMonth() + 1 : 1;
        const endMonth = (year === currentYear) ? currentMonth : 12;
        
        for (let month = startMonth; month <= endMonth; month++) {
          const monthKey = `${year}-${String(month).padStart(2, '0')}`;
          
          // Prix des cigarettes pour ce mois
          const cigarettePrice = cigarettePriceData[country][year] || cigarettePriceData[country][2025];
          const packsPerMonth = (cigarettesPerDay * 30) / 20; // 20 cigarettes par paquet
          const monthlySpent = packsPerMonth * cigarettePrice;
          
          totalSpent += monthlySpent;
          
          // Prix du Bitcoin pour ce mois
          const btcPrice = btcMonthlyPrices[monthKey];
          if (btcPrice) {
            const btcBought = monthlySpent / btcPrice;
            totalBTC += btcBought;
            monthCount++;
          }
        }
      }
      
      const currentBTCPrice = data.prices[data.prices.length - 1][1];
      const currentValue = totalBTC * currentBTCPrice;
      const avgBTCPrice = totalSpent / totalBTC;
      
      setResult({
        totalSpent,
        currentValue,
        btcAmount: totalBTC,
        avgBtcPrice: avgBTCPrice,
        currentBtcPrice: currentBTCPrice
      });
      
    } catch (error) {
      console.error('Error:', error);
      alert(t.error);
    } finally {
      setLoading(false);
    }
  };

  const formatCurrency = (value) => {
    return new Intl.NumberFormat('en-US', {
      style: 'currency',
      currency: 'USD',
      minimumFractionDigits: 0,
      maximumFractionDigits: 0
    }).format(value);
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-purple-600 via-purple-700 to-indigo-800 p-4">
      <div className="max-w-4xl mx-auto">
        {/* Header */}
        <div className="text-center mb-8 pt-8">
          <div className="flex justify-center items-center gap-3 mb-4">
            <Bitcoin className="w-12 h-12 text-yellow-400" />
            <h1 className="text-5xl font-bold text-white">{t.title}</h1>
            <Cigarette className="w-12 h-12 text-red-400" />
          </div>
          <p className="text-xl text-purple-100">{t.subtitle}</p>
          
          {/* Language selector */}
          <div className="flex justify-center gap-2 mt-4">
            <button
              onClick={() => setLanguage('fr')}
              className={`px-4 py-2 rounded ${language === 'fr' ? 'bg-white text-purple-700' : 'bg-purple-500 text-white'}`}
            >
              FR
            </button>
            <button
              onClick={() => setLanguage('en')}
              className={`px-4 py-2 rounded ${language === 'en' ? 'bg-white text-purple-700' : 'bg-purple-500 text-white'}`}
            >
              EN
            </button>
            <button
              onClick={() => setLanguage('es')}
              className={`px-4 py-2 rounded ${language === 'es' ? 'bg-white text-purple-700' : 'bg-purple-500 text-white'}`}
            >
              ES
            </button>
          </div>
        </div>

        {/* Calculator Card */}
        <div className="bg-white rounded-2xl shadow-2xl p-8 mb-6">
          <div className="grid md:grid-cols-2 gap-6">
            <div>
              <label className="block text-gray-700 font-semibold mb-2">
                <Globe className="inline w-5 h-5 mr-2" />
                {t.country}
              </label>
              <select
                value={country}
                onChange={(e) => setCountry(e.target.value)}
                className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none"
              >
                <option value="USA">USA</option>
                <option value="Canada">Canada</option>
                <option value="France">France</option>
                <option value="Germany">Germany / Deutschland</option>
                <option value="UK">United Kingdom</option>
                <option value="Spain">Spain / España</option>
                <option value="Italy">Italy / Italia</option>
                <option value="Australia">Australia</option>
              </select>
            </div>

            <div>
              <label className="block text-gray-700 font-semibold mb-2">
                <Cigarette className="inline w-5 h-5 mr-2" />
                {t.cigarettesPerDay}
              </label>
              <input
                type="number"
                min="1"
                max="60"
                value={cigarettesPerDay}
                onChange={(e) => setCigarettesPerDay(parseInt(e.target.value))}
                className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none"
              />
            </div>

            <div className="md:col-span-2">
              <label className="block text-gray-700 font-semibold mb-2">
                <TrendingUp className="inline w-5 h-5 mr-2" />
                {t.smokingSince}
              </label>
              <input
                type="range"
                min="1"
                max="15"
                value={yearsSmoking}
                onChange={(e) => setYearsSmoking(parseInt(e.target.value))}
                className="w-full"
              />
              <div className="text-center text-2xl font-bold text-purple-600 mt-2">
                {yearsSmoking} {t.years}
              </div>
            </div>
          </div>

          <button
            onClick={calculateInvestment}
            disabled={loading}
            className="w-full mt-6 py-4 bg-gradient-to-r from-purple-600 to-indigo-600 text-white text-xl font-bold rounded-lg hover:from-purple-700 hover:to-indigo-700 transition-all transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            {loading ? t.loading : t.calculate}
          </button>
        </div>

        {/* Results */}
        {result && (
          <div className="bg-gradient-to-r from-red-500 to-orange-500 rounded-2xl shadow-2xl p-8 text-white animate-fadeIn">
            <div className="text-center mb-6">
              <h2 className="text-3xl font-bold mb-2">😱 {t.result}</h2>
              <div className="text-6xl font-extrabold my-6">
                {formatCurrency(result.currentValue)}
              </div>
            </div>

            <div className="grid md:grid-cols-2 gap-6 mt-6 pt-6 border-t-2 border-white/30">
              <div>
                <p className="text-white/80 text-sm mb-1">{t.totalSpent}</p>
                <p className="text-2xl font-bold">{formatCurrency(result.totalSpent)}</p>
              </div>
              <div>
                <p className="text-white/80 text-sm mb-1">{t.btcAmount}</p>
                <p className="text-2xl font-bold">{result.btcAmount.toFixed(4)} BTC</p>
              </div>
              <div>
                <p className="text-white/80 text-sm mb-1">{t.avgBtcPrice}</p>
                <p className="text-2xl font-bold">{formatCurrency(result.avgBtcPrice)}</p>
              </div>
              <div>
                <p className="text-white/80 text-sm mb-1">Bitcoin {new Date().getFullYear()}</p>
                <p className="text-2xl font-bold">{formatCurrency(result.currentBtcPrice)}</p>
              </div>
            </div>
          </div>
        )}

        {/* Disclaimer */}
        <div className="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded mt-6">
          <div className="flex items-start">
            <AlertCircle className="w-6 h-6 text-yellow-600 mr-3 flex-shrink-0 mt-1" />
            <p className="text-sm text-yellow-800">{t.disclaimer}</p>
          </div>
        </div>

        {/* Methodology Link */}
        <div className="text-center mt-6">
          <button
            onClick={() => setShowMethodology(!showMethodology)}
            className="text-white underline hover:text-purple-200 flex items-center gap-2 mx-auto"
          >
            <Info className="w-5 h-5" />
            {t.methodology}
          </button>
        </div>

        {/* Methodology Section */}
        {showMethodology && (
          <div className="bg-white rounded-2xl shadow-2xl p-8 mt-6 mb-8">
            <h3 className="text-2xl font-bold mb-4">Méthodologie / Methodology</h3>
            
            <div className="space-y-4 text-gray-700">
              <section>
                <h4 className="font-bold text-lg mb-2">📊 Sources des données</h4>
                <ul className="list-disc pl-6 space-y-1">
                  <li><strong>Bitcoin:</strong> Prix historiques via CoinGecko API (données quotidiennes/mensuelles depuis juillet 2010)</li>
                  <li><strong>USA:</strong> U.S. Bureau of Labor Statistics - Consumer Price Index for Cigarettes</li>
                  <li><strong>Canada:</strong> Statistics Canada - Average Retail Price for Cigarettes</li>
                  <li><strong>France:</strong> OFDT (Observatoire Français des Drogues et Toxicomanies)</li>
                  <li><strong>Europe:</strong> Euromonitor, WHO Global Tobacco Price Database</li>
                  <li><strong>Australia:</strong> Australian Government Department of Health</li>
                </ul>
              </section>

              <section>
                <h4 className="font-bold text-lg mb-2">🧮 Méthode de calcul</h4>
                <ol className="list-decimal pl-6 space-y-2">
                  <li><strong>Période:</strong> Calcul depuis juillet 2010 (première cotation fiable du Bitcoin) jusqu'à aujourd'hui</li>
                  <li><strong>Investissement simulé:</strong> Achat mensuel de Bitcoin avec l'argent qui aurait été dépensé en cigarettes</li>
                  <li><strong>Prix des cigarettes:</strong> Prix moyen annuel par pays, ajusté mensuellement</li>
                  <li><strong>Prix du Bitcoin:</strong> Prix mensuel moyen basé sur les données historiques réelles</li>
                  <li><strong>DCA (Dollar Cost Averaging):</strong> Simulation d'achats réguliers, méthode reconnue comme plus réaliste qu'un achat unique</li>
                </ol>
              </section>

              <section>
                <h4 className="font-bold text-lg mb-2">📈 Estimation des prix des cigarettes</h4>
                <p>Les prix sont basés sur les données officielles disponibles. Pour les années où les données exactes manquent, nous avons appliqué:</p>
                <ul className="list-disc pl-6 space-y-1 mt-2">
                  <li>Taux d'inflation du tabac spécifique à chaque pays</li>
                  <li>Augmentations fiscales documentées</li>
                  <li>Interpolation linéaire entre points de données connus</li>
                </ul>
              </section>

              <section>
                <h4 className="font-bold text-lg mb-2">⚠️ Limites et avertissements</h4>
                <ul className="list-disc pl-6 space-y-1">
                  <li>Calcul à titre indicatif et éducatif uniquement</li>
                  <li>Ne tient pas compte des variations régionales de prix</li>
                  <li>Ne constitue pas un conseil financier ou d'investissement</li>
                  <li>Les performances passées ne garantissent pas les résultats futurs</li>
                  <li>Ne considère pas les frais de transaction Bitcoin</li>
                </ul>
              </section>

              <section className="bg-blue-50 p-4 rounded-lg">
                <h4 className="font-bold text-lg mb-2">🔗 Liens utiles</h4>
                <ul className="space-y-1">
                  <li><a href="https://www.coingecko.com/en/coins/bitcoin" target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:underline">CoinGecko - Bitcoin Historical Data</a></li>
                  <li><a href="https://www.bls.gov/cpi/" target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:underline">U.S. Bureau of Labor Statistics</a></li>
                  <li><a href="https://www.who.int/data/gho/data/themes/topics/topic-details/GHO/gho-tobacco-control-raise-taxes-price" target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:underline">WHO - Tobacco Prices Database</a></li>
                  <li><a href="https://www.statcan.gc.ca" target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:underline">Statistics Canada</a></li>
                </ul>
              </section>
            </div>
          </div>
        )}

        {/* Footer */}
        <div className="text-center text-white text-sm py-8 opacity-75">
          <p>© 2025 - Projet éducatif à but non lucratif</p>
          <p className="mt-2">Il n'est jamais trop tard pour investir dans votre santé 💪</p>
        </div>
      </div>
    </div>
  );
}
